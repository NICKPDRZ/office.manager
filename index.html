<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Hardware de Oficina Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        canvas { 
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .tool-btn { transition: all 0.2s; }
        .tool-btn:active { transform: scale(0.95); }
        .tool-active { background-color: #eff6ff; border-color: #3b82f6; color: #1d4ed8; }
        
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: #2563eb; cursor: pointer; margin-top: -6px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #bfdbfe; border-radius: 2px;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Animation for connection line */
        @keyframes dash {
            to { stroke-dashoffset: -10; }
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-white shadow-md z-20 p-3 flex justify-between items-center relative">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 text-white p-2 rounded-lg shadow-blue-200 shadow-lg">
                <i class="fa-solid fa-server"></i>
            </div>
            <div>
                <h1 class="font-bold text-gray-800 text-lg leading-tight">Office Manager</h1>
                <p class="text-xs text-gray-500">Diseño + Inventario Excel</p>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="absolute left-1/2 transform -translate-x-1/2 w-1/3 min-w-[300px]">
            <div class="relative group">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fa-solid fa-magnifying-glass text-gray-400 group-focus-within:text-blue-500 transition-colors"></i>
                </div>
                <input type="text" id="searchInput" 
                    class="block w-full pl-10 pr-4 py-2 border-2 border-gray-100 rounded-full leading-5 bg-gray-50 text-gray-900 placeholder-gray-400 focus:outline-none focus:bg-white focus:border-blue-500 transition-all shadow-sm" 
                    placeholder="Buscar puesto (ej: D-12)..." autocomplete="off">
                <div id="searchResults" class="hidden absolute top-full left-0 w-full bg-white mt-2 rounded-xl shadow-xl border border-gray-100 overflow-hidden z-50 max-h-60 overflow-y-auto"></div>
            </div>
        </div>

        <div class="flex gap-2">
            <input type="file" id="uploadInput" accept="image/*" class="hidden">
            <button onclick="document.getElementById('uploadInput').click()" class="bg-white text-gray-600 px-3 py-2 rounded-lg font-medium hover:bg-gray-50 transition border border-gray-200 text-sm shadow-sm">
                <i class="fa-solid fa-upload mr-1"></i> Plano
            </button>
            <button onclick="exportToExcel()" class="bg-green-600 text-white px-3 py-2 rounded-lg font-medium hover:bg-green-700 transition shadow-sm text-sm flex items-center gap-2">
                <i class="fa-solid fa-file-excel"></i> Exportar Excel
            </button>
            <button onclick="exportImage()" class="bg-slate-700 text-white px-3 py-2 rounded-lg font-medium hover:bg-slate-800 transition shadow-sm text-sm">
                <i class="fa-solid fa-image mr-1"></i> Imagen
            </button>
        </div>
    </header>

    <!-- Main Workspace -->
    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- Sidebar Tools -->
        <aside class="w-72 bg-white border-r border-gray-200 flex flex-col shadow-lg z-10 overflow-y-auto" id="sidebar">
            
            <!-- Map Controls / Add Points -->
            <div class="p-4 border-b border-gray-100 bg-gray-50">
                <h3 class="font-bold text-gray-800 text-sm mb-3 flex items-center gap-2">
                    <i class="fa-solid fa-location-dot text-red-500"></i> Gestión de Puestos
                </h3>
                
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <button id="addPointBtn" onclick="toggleAddPointMode()" class="bg-white border border-gray-300 text-gray-600 py-2 px-2 rounded-lg text-xs font-bold hover:bg-blue-50 hover:text-blue-600 hover:border-blue-300 transition flex flex-col items-center gap-1 shadow-sm">
                        <i class="fa-solid fa-plus-circle text-lg"></i> Nuevo Puesto
                    </button>
                    <button id="toggleNetworkBtn" onclick="toggleNetworkMode()" class="bg-white border border-gray-300 text-gray-600 py-2 px-2 rounded-lg text-xs font-bold hover:bg-blue-50 hover:text-blue-600 hover:border-blue-300 transition flex flex-col items-center gap-1 shadow-sm">
                        <i class="fa-regular fa-eye text-lg"></i> Ver/Editar
                    </button>
                </div>
                
                <p class="text-[10px] text-gray-400 leading-tight mt-2 text-center">
                    <span id="modeStatus">Modo Navegación</span>
                </p>
            </div>

            <!-- Context Actions (Dynamic) -->
            <div id="pointContextActions" class="hidden p-4 bg-blue-50 border-b border-blue-100 animate-fade-in">
                <h3 class="font-bold text-blue-800 text-xs uppercase tracking-wider mb-2">Puesto Seleccionado: <span id="selectedPointLabel" class="text-blue-600 text-sm"></span></h3>
                <div class="space-y-2">
                    <button onclick="addItemToSelectedPoint('monitor')" class="w-full bg-white text-blue-700 border border-blue-200 hover:bg-blue-100 p-2 rounded-lg text-xs font-bold flex items-center justify-center gap-2 transition">
                        <i class="fa-solid fa-desktop"></i> Monitor Doble
                    </button>
                    <button onclick="addItemToSelectedPoint('monitor-single')" class="w-full bg-white text-blue-600 border border-blue-200 hover:bg-blue-50 p-2 rounded-lg text-xs font-bold flex items-center justify-center gap-2 transition">
                        <i class="fa-solid fa-tv"></i> Monitor Simple
                    </button>
                    <button onclick="addItemToSelectedPoint('dock')" class="w-full bg-white text-indigo-700 border border-indigo-200 hover:bg-indigo-100 p-2 rounded-lg text-xs font-bold flex items-center justify-center gap-2 transition">
                        <i class="fa-solid fa-plug"></i> Dock Station
                    </button>
                    <button onclick="addItemToSelectedPoint('desk')" class="w-full bg-orange-50 text-orange-700 border border-orange-200 hover:bg-orange-100 p-2 rounded-lg text-xs font-bold flex items-center justify-center gap-2 transition">
                        <i class="fa-solid fa-table"></i> Escritorio
                    </button>
                     <button onclick="deleteSelectedPoint()" class="w-full bg-red-50 text-red-600 border border-red-200 hover:bg-red-100 p-2 rounded-lg text-xs font-bold flex items-center justify-center gap-2 transition mt-2">
                        <i class="fa-solid fa-trash"></i> Eliminar Puesto
                    </button>
                </div>
            </div>

            <!-- Hardware Tools -->
            <div class="p-4 space-y-3 flex-1">
                <h3 class="font-semibold text-gray-400 text-xs uppercase tracking-wider mb-2">Mobiliario & Hardware</h3>
                
                <!-- Desk Option -->
                <button onclick="addItem('desk')" class="tool-btn w-full bg-white border-2 border-orange-100 hover:border-orange-400 hover:bg-orange-50 text-left p-3 rounded-xl flex items-center gap-3 group shadow-sm mb-4">
                    <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center text-orange-600 group-hover:bg-orange-200 group-hover:text-orange-800 transition-colors">
                        <i class="fa-solid fa-table"></i>
                    </div>
                    <div>
                        <div class="font-bold text-gray-700 text-sm">Escritorio</div>
                        <div class="text-[10px] text-gray-400">Mobiliario</div>
                    </div>
                </button>

                <h3 class="font-semibold text-gray-400 text-xs uppercase tracking-wider mb-2 pt-2 border-t border-gray-100">Equipos</h3>

                <button onclick="addItem('monitor')" class="tool-btn w-full bg-white border-2 border-gray-100 hover:border-blue-500 hover:bg-blue-50 text-left p-3 rounded-xl flex items-center gap-3 group shadow-sm">
                    <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center text-gray-600 group-hover:bg-blue-200 group-hover:text-blue-700 transition-colors">
                        <i class="fa-solid fa-desktop"></i>
                    </div>
                    <div>
                        <div class="font-bold text-gray-700 text-sm">Doble Monitor</div>
                        <div class="text-[10px] text-gray-400">Kit Dual (2x)</div>
                    </div>
                </button>

                <button onclick="addItem('monitor-single')" class="tool-btn w-full bg-white border-2 border-gray-100 hover:border-blue-400 hover:bg-blue-50 text-left p-3 rounded-xl flex items-center gap-3 group shadow-sm">
                    <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center text-gray-600 group-hover:bg-blue-200 group-hover:text-blue-600 transition-colors">
                        <i class="fa-solid fa-tv"></i>
                    </div>
                    <div>
                        <div class="font-bold text-gray-700 text-sm">Monitor Simple</div>
                        <div class="text-[10px] text-gray-400">Kit Simple (1x)</div>
                    </div>
                </button>

                <button onclick="addItem('dock')" class="tool-btn w-full bg-white border-2 border-gray-100 hover:border-indigo-500 hover:bg-indigo-50 text-left p-3 rounded-xl flex items-center gap-3 group shadow-sm">
                    <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center text-gray-600 group-hover:bg-indigo-200 group-hover:text-indigo-700 transition-colors">
                        <i class="fa-solid fa-plug"></i>
                    </div>
                    <div>
                        <div class="font-bold text-gray-700 text-sm">Docking Station</div>
                        <div class="text-[10px] text-gray-400">USB-C Hub</div>
                    </div>
                </button>

                <div class="h-px bg-gray-100 my-4"></div>

                <!-- Selection Controls -->
                <div id="selectionControls" class="opacity-50 pointer-events-none transition-all duration-200 bg-gray-50 p-4 rounded-xl border border-gray-200">
                    <p class="text-xs font-bold text-gray-500 mb-2 uppercase flex justify-between">
                        Selección
                    </p>
                    
                    <div id="assignmentInfo" class="mb-3 text-xs bg-blue-100 text-blue-800 p-2 rounded border border-blue-200 hidden">
                        <i class="fa-solid fa-link mr-1"></i> <span id="assignmentText">Sin asignar</span>
                    </div>

                    <div class="mb-4">
                        <label class="flex justify-between text-xs text-gray-600 mb-1 font-semibold">
                            <span>Tamaño</span>
                            <span id="sizeValueDisplay">100%</span>
                        </label>
                        <input type="range" id="sizeSlider" min="20" max="250" value="60" class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer">
                    </div>

                    <button onclick="deleteSelected()" class="w-full bg-white text-red-600 border border-red-200 hover:bg-red-50 hover:border-red-300 p-2 rounded-lg flex items-center justify-center gap-2 font-medium text-xs shadow-sm transition">
                        <i class="fa-solid fa-trash"></i> Eliminar
                    </button>
                </div>
            </div>

            <!-- Summary Footer -->
            <div class="mt-auto bg-slate-800 text-white p-4 text-center">
                <button onclick="resetView()" class="text-xs text-slate-400 hover:text-white mb-2 flex items-center justify-center gap-1 w-full">
                    <i class="fa-solid fa-compress-arrows-alt"></i> Centrar Mapa
                </button>
                <div class="grid grid-cols-4 gap-1">
                    <div class="bg-slate-700 rounded p-1">
                        <div class="font-bold text-blue-400 text-sm" id="count-monitor">0</div>
                        <div class="text-[9px] text-slate-300">Dual</div>
                    </div>
                     <div class="bg-slate-700 rounded p-1">
                        <div class="font-bold text-blue-300 text-sm" id="count-monitor-single">0</div>
                        <div class="text-[9px] text-slate-300">Simp</div>
                    </div>
                    <div class="bg-slate-700 rounded p-1">
                        <div class="font-bold text-indigo-400 text-sm" id="count-dock">0</div>
                        <div class="text-[9px] text-slate-300">Dock</div>
                    </div>
                     <div class="bg-slate-700 rounded p-1">
                        <div class="font-bold text-orange-400 text-sm" id="count-desk">0</div>
                        <div class="text-[9px] text-slate-300">Mesa</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Canvas Area -->
        <main class="flex-1 bg-gray-200 relative overflow-hidden cursor-grab active:cursor-grabbing" id="canvasContainer">
            
            <div id="emptyState" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 pointer-events-none z-0">
                <div class="bg-white p-8 rounded-full shadow-lg mb-4">
                    <i class="fa-regular fa-map text-6xl text-blue-200"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-600">Bienvenido al Office Manager</h2>
                <p class="text-gray-500 mt-2">Sube tu plano para asignar hardware y generar reportes</p>
                <button onclick="document.getElementById('uploadInput').click()" class="mt-6 bg-blue-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-700 shadow-lg pointer-events-auto transition">
                    Subir Imagen del Plano
                </button>
            </div>

            <canvas id="designCanvas" class="absolute top-0 left-0 hidden shadow-2xl"></canvas>
            
            <!-- Zoom Controls -->
            <div class="absolute bottom-6 right-6 flex flex-col gap-2 z-10">
                <button onclick="changeZoom(0.1)" class="w-10 h-10 bg-white rounded-lg shadow-lg text-gray-600 hover:text-blue-600 flex items-center justify-center font-bold text-xl transition transform hover:scale-105">+</button>
                <button onclick="changeZoom(-0.1)" class="w-10 h-10 bg-white rounded-lg shadow-lg text-gray-600 hover:text-blue-600 flex items-center justify-center font-bold text-xl transition transform hover:scale-105">-</button>
            </div>

            <!-- Toast Notification -->
            <div id="toast" class="absolute top-6 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-full shadow-xl text-sm font-medium opacity-0 transition-opacity pointer-events-none z-50 flex items-center gap-2">
                <i class="fa-solid fa-circle-check text-green-400"></i>
                <span id="toastMsg">Acción completada</span>
            </div>
            
            <!-- Context Action Tooltip (Adding Points) -->
            <div id="actionTooltip" class="hidden absolute top-4 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white px-4 py-2 rounded-full shadow-lg z-50 text-sm font-bold animate-bounce">
                <i class="fa-solid fa-location-dot mr-2"></i> Haz clic en el mapa para colocar el puesto
            </div>
        </main>
    </div>

    <!-- Hidden Link for Download -->
    <a id="downloadLink" class="hidden"></a>

    <script>
        // --- Database: Network Points ---
        let networkPoints = [
            {id: 'D-62', x: 0.12, y: 0.19}, {id: 'D-21', x: 0.16, y: 0.19}, {id: 'D-20', x: 0.21, y: 0.19}, {id: 'D-18', x: 0.25, y: 0.19},
            {id: 'D-22', x: 0.16, y: 0.25}, {id: 'D-46', x: 0.24, y: 0.26}, {id: 'D-17', x: 0.28, y: 0.26}, {id: 'D-19', x: 0.28, y: 0.22},
            {id: 'D-23', x: 0.19, y: 0.32}, {id: 'D-24', x: 0.21, y: 0.36},
            {id: 'D-16', x: 0.32, y: 0.21}, {id: 'D-69', x: 0.36, y: 0.23}, {id: 'D-14', x: 0.40, y: 0.23}, {id: 'D-11', x: 0.45, y: 0.21},
            {id: 'D-15', x: 0.32, y: 0.26}, {id: 'D-67', x: 0.36, y: 0.26}, {id: 'D-45', x: 0.40, y: 0.26}, {id: 'D-12', x: 0.45, y: 0.26},
            {id: 'D-10', x: 0.54, y: 0.23}, {id: 'D-09', x: 0.54, y: 0.25}, {id: 'D-07', x: 0.60, y: 0.23}, {id: 'D-08', x: 0.60, y: 0.25},
            {id: 'D-04', x: 0.69, y: 0.26}, {id: 'D-05', x: 0.69, y: 0.30}, {id: 'D-06', x: 0.69, y: 0.34}, 
            {id: 'D-03', x: 0.71, y: 0.39}, {id: 'D-02', x: 0.71, y: 0.43}, {id: 'D-01', x: 0.67, y: 0.47},
            {id: 'D-13', x: 0.28, y: 0.35}, {id: 'D-68', x: 0.32, y: 0.35}, {id: 'D-49', x: 0.36, y: 0.35}, {id: 'D-64', x: 0.41, y: 0.35}, {id: 'D-65', x: 0.45, y: 0.35},
            {id: 'D-42', x: 0.32, y: 0.39}, {id: 'D-50', x: 0.36, y: 0.39}, {id: 'D-47', x: 0.41, y: 0.39}, {id: 'D-51', x: 0.45, y: 0.39},
            {id: 'D-48', x: 0.32, y: 0.43}, {id: 'D-66', x: 0.36, y: 0.43},
            {id: 'D-43', x: 0.26, y: 0.35}, {id: 'D-44', x: 0.26, y: 0.45},
            {id: 'D-53', x: 0.22, y: 0.46}, {id: 'D-54', x: 0.20, y: 0.49},
            {id: 'D-55', x: 0.17, y: 0.53}, {id: 'D-56', x: 0.15, y: 0.55},
            {id: 'D-63', x: 0.28, y: 0.53},
            {id: 'D-26', x: 0.19, y: 0.63}, {id: 'D-70', x: 0.21, y: 0.63}, {id: 'D-27', x: 0.24, y: 0.65},
            {id: 'D-28', x: 0.27, y: 0.69}, {id: 'D-29', x: 0.30, y: 0.72},
            {id: 'D-30', x: 0.33, y: 0.78}, {id: 'D-31', x: 0.36, y: 0.81},
            {id: 'D-32', x: 0.39, y: 0.86}, {id: 'D-33', x: 0.42, y: 0.89},
            {id: 'D-58', x: 0.34, y: 0.65}, {id: 'D-59', x: 0.37, y: 0.68}, {id: 'D-60', x: 0.39, y: 0.70},
            {id: 'D-52', x: 0.44, y: 0.77}, {id: 'D-34', x: 0.49, y: 0.77}, {id: 'D-61', x: 0.47, y: 0.81},
            {id: 'D-38', x: 0.46, y: 0.48}, {id: 'D-39', x: 0.46, y: 0.52}
        ];

        // --- Configuration & State ---
        const canvas = document.getElementById('designCanvas');
        const ctx = canvas.getContext('2d');
        const uploadInput = document.getElementById('uploadInput');
        const emptyState = document.getElementById('emptyState');
        const sizeSlider = document.getElementById('sizeSlider');
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        
        let items = []; 
        let selectedItemId = null;
        let selectedNetworkPointId = null; 
        let backgroundImg = null;
        
        // Settings
        const ASSOCIATION_DIST = 100; // Pixels for snapping/associating

        // Camera
        let camera = { x: 0, y: 0, zoom: 1 };
        let isDraggingCanvas = false;
        let lastMouseX = 0, lastMouseY = 0;

        // Interaction
        let isDraggingItem = false;
        let isNetworkMode = false;
        let isAddingPointMode = false; 
        let foundPoint = null; 

        // --- Initialization ---
        
        uploadInput.addEventListener('change', handleImageUpload);
        canvas.addEventListener('mousedown', handleMouseDown);
        window.addEventListener('mousemove', handleMouseMove); 
        window.addEventListener('mouseup', handleMouseUp);
        canvas.addEventListener('wheel', handleWheel, { passive: false });
        canvas.addEventListener('touchstart', handleTouchStart, {passive: false});
        canvas.addEventListener('touchmove', handleTouchMove, {passive: false});
        canvas.addEventListener('touchend', handleMouseUp);
        sizeSlider.addEventListener('input', handleResizeChange);
        searchInput.addEventListener('input', handleSearch);
        document.addEventListener('keydown', (e) => {
            if ((e.key === 'Delete' || e.key === 'Backspace')) {
                if (selectedItemId !== null) deleteSelected();
                else if (selectedNetworkPointId !== null && isNetworkMode) deleteSelectedPoint();
            } else if (e.key === 'Escape') {
                if (isAddingPointMode) toggleAddPointMode();
            }
        });

        // --- Search Logic ---
        function handleSearch(e) {
            const query = e.target.value.toUpperCase().trim();
            searchResults.innerHTML = '';
            
            if (query.length === 0) {
                searchResults.classList.add('hidden');
                foundPoint = null;
                draw();
                return;
            }
            const matches = networkPoints.filter(p => p.id.toUpperCase().includes(query));
            if (matches.length > 0) {
                searchResults.classList.remove('hidden');
                matches.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 flex justify-between items-center text-sm';
                    div.innerHTML = `<span class="font-bold text-gray-700">${p.id}</span> <span class="text-xs text-blue-500">Ver <i class="fa-solid fa-arrow-right"></i></span>`;
                    div.onclick = () => focusOnPoint(p);
                    searchResults.appendChild(div);
                });
            } else {
                searchResults.innerHTML = '<div class="p-4 text-gray-400 text-center text-xs">No encontrado</div>';
                searchResults.classList.remove('hidden');
            }
        }

        function focusOnPoint(point) {
            if (!backgroundImg) return showToast("Sube un plano primero", "error");
            foundPoint = point;
            searchResults.classList.add('hidden');
            searchInput.value = point.id;
            const targetZoom = 3;
            const pX = point.x * canvas.width;
            const pY = point.y * canvas.height;
            animateCameraTo((canvas.width/2/targetZoom)-pX, (canvas.height/2/targetZoom)-pY, targetZoom);
        }

        function animateCameraTo(targetX, targetY, targetZoom) {
            let steps = 20;
            let dx = (targetX - camera.x) / steps;
            let dy = (targetY - camera.y) / steps;
            let dz = (targetZoom - camera.zoom) / steps;
            function step() {
                camera.x += dx; camera.y += dy; camera.zoom += dz;
                draw();
                steps--;
                if(steps > 0) requestAnimationFrame(step);
            }
            step();
        }

        // --- Helper: Find Nearest Point ---
        function getNearestPoint(item) {
            if (!backgroundImg) return null;
            let closest = null;
            let minDist = Infinity;
            networkPoints.forEach((p) => {
                const px = p.x * canvas.width;
                const py = p.y * canvas.height;
                const dist = Math.sqrt((item.x - px)**2 + (item.y - py)**2);
                if (dist < minDist) {
                    minDist = dist;
                    closest = p;
                }
            });
            if (minDist < ASSOCIATION_DIST) {
                return { point: closest, dist: minDist };
            }
            return null;
        }

        // --- Drawing ---

        function draw() {
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (!backgroundImg) return;

            ctx.save();
            ctx.scale(camera.zoom, camera.zoom);
            ctx.translate(camera.x, camera.y);

            ctx.drawImage(backgroundImg, 0, 0);

            // Layer 1: Desks (Visual Background)
            items.filter(i => i.type === 'desk').forEach(item => drawItem(item));

            // Layer 2: Connection Lines
            drawAssignments();

            // Layer 3: Network Points
            if (isNetworkMode || isAddingPointMode || foundPoint) {
                drawNetworkPoints(1.0); // Full opacity
            } else {
                drawNetworkPoints(0.3); // Faint for reference
            }

            // Layer 4: Hardware (Monitors, Docks)
            items.filter(i => i.type !== 'desk').forEach(item => drawItem(item));

            if (foundPoint) {
                const px = foundPoint.x * backgroundImg.width;
                const py = foundPoint.y * backgroundImg.height;
                ctx.beginPath(); ctx.arc(px, py, 30, 0, Math.PI * 2);
                ctx.strokeStyle = '#ef4444'; ctx.lineWidth = 4; ctx.stroke();
            }

            ctx.restore();
            updateUI();
        }

        function drawAssignments() {
            items.forEach(item => {
                if (item.type === 'desk') return; // Don't draw lines for desks
                const nearest = getNearestPoint(item);
                if (nearest) {
                    const px = nearest.point.x * backgroundImg.width;
                    const py = nearest.point.y * backgroundImg.height;
                    
                    ctx.beginPath();
                    ctx.moveTo(item.x, item.y);
                    ctx.lineTo(px, py);
                    ctx.strokeStyle = 'rgba(37, 99, 235, 0.6)'; 
                    ctx.lineWidth = 2 / camera.zoom;
                    ctx.setLineDash([5, 5]); // Dashed line
                    ctx.stroke();
                    ctx.setLineDash([]); // Reset
                    
                    // Small dot at intersection
                    ctx.beginPath();
                    ctx.arc(px, py, 3, 0, Math.PI*2);
                    ctx.fillStyle = '#2563eb';
                    ctx.fill();
                }
            });
        }

        function drawNetworkPoints(opacity = 0.8) {
            networkPoints.forEach(p => {
                const px = p.x * backgroundImg.width;
                const py = p.y * backgroundImg.height;
                const isSelected = p.id === selectedNetworkPointId;
                const isFound = foundPoint && foundPoint.id === p.id;

                ctx.beginPath();
                ctx.arc(px, py, (isSelected || isFound) ? 8 : 5, 0, Math.PI * 2);
                ctx.fillStyle = (isSelected || isFound) ? '#ef4444' : `rgba(59, 130, 246, ${opacity})`;
                ctx.fill();
                if (isSelected) {
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }

                // Label
                if (isNetworkMode || isSelected || isFound || opacity > 0.5) {
                    ctx.font = 'bold 12px Arial';
                    ctx.textAlign = 'center';
                    const textWidth = ctx.measureText(p.id).width;
                    ctx.fillStyle = `rgba(255,255,255,${opacity > 0.5 ? 0.9 : 0.5})`;
                    ctx.fillRect(px - textWidth/2 - 3, py - 24, textWidth + 6, 16);
                    ctx.fillStyle = (isSelected || isFound) ? '#dc2626' : `rgba(30, 58, 138, ${opacity})`;
                    ctx.fillText(p.id, px, py - 12);
                }
            });
        }

        function drawItem(item) {
            const isSelected = item.id === selectedItemId;
            ctx.save(); ctx.translate(item.x, item.y);
            if (isSelected) {
                ctx.shadowColor = 'rgba(37, 99, 235, 0.6)'; ctx.shadowBlur = 15;
                ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 2 / camera.zoom;
                ctx.strokeRect(-item.width/2 - 4, -item.height/2 - 4, item.width + 8, item.height + 8);
                ctx.shadowBlur = 0;
            }
            if (item.type === 'monitor') drawMonitorIcon(ctx, -item.width/2, -item.height/2, item.width, item.height);
            else if (item.type === 'monitor-single') drawSingleMonitorIcon(ctx, -item.width/2, -item.height/2, item.width, item.height);
            else if (item.type === 'dock') drawDockIcon(ctx, -item.width/2, -item.height/2, item.width, item.height);
            else if (item.type === 'desk') drawDeskIcon(ctx, -item.width/2, -item.height/2, item.width, item.height);
            ctx.restore();
        }

        // Icons
        function drawMonitorIcon(ctx, x, y, w, h) {
            ctx.fillStyle = '#1f2937'; const mw = (w / 2) - 2; const mh = h * 0.7;
            ctx.fillRect(x, y, mw, mh); ctx.fillStyle = '#374151'; ctx.fillRect(x+2, y+2, mw-4, mh-4);
            ctx.fillStyle = '#1f2937'; ctx.fillRect(x + mw + 4, y, mw, mh); ctx.fillStyle = '#374151'; ctx.fillRect(x + mw + 6, y+2, mw-4, mh-4);
            ctx.fillStyle = '#9ca3af'; ctx.fillRect(x + w/2 - 2, y + mh, 4, h - mh); ctx.fillRect(x + w/2 - 8, y + h - 2, 16, 2); 
        }
        function drawSingleMonitorIcon(ctx, x, y, w, h) {
            const mh = h * 0.75; ctx.fillStyle = '#1e3a8a'; ctx.fillRect(x, y, w, mh);
            ctx.fillStyle = '#3b82f6'; ctx.fillRect(x+3, y+3, w-6, mh-6);
            ctx.fillStyle = '#9ca3af'; ctx.fillRect(x + w/2 - 3, y + mh, 6, h - mh); ctx.fillRect(x + w/2 - 10, y + h - 3, 20, 3); 
        }
        function drawDockIcon(ctx, x, y, w, h) {
            ctx.fillStyle = '#4f46e5'; ctx.beginPath(); ctx.roundRect(x, y + h/4, w, h/2, 4); ctx.fill();
            ctx.fillStyle = '#a5b4fc'; ctx.beginPath(); ctx.arc(x + w*0.3, y + h/2, w*0.05, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.arc(x + w*0.6, y + h/2, w*0.05, 0, Math.PI * 2); ctx.fill();
            ctx.strokeStyle = '#312e81'; ctx.lineWidth = Math.max(1, w * 0.05); ctx.beginPath(); ctx.moveTo(x + w, y + h/2); ctx.lineTo(x + w + (w*0.15), y + h/2); ctx.stroke();
        }
        function drawDeskIcon(ctx, x, y, w, h) {
             // Desk Top
            ctx.fillStyle = '#d4a373'; // Wood color
            ctx.beginPath();
            ctx.roundRect(x, y, w, h, 4);
            ctx.fill();
            
            // Subtle wood grain/detail
            ctx.fillStyle = '#c59263';
            ctx.fillRect(x, y + h - 5, w, 5); // Edge detail
        }

        // --- Logic ---

        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                backgroundImg = new Image();
                backgroundImg.onload = function() {
                    canvas.width = backgroundImg.width;
                    canvas.height = backgroundImg.height;
                    canvas.classList.remove('hidden');
                    emptyState.classList.add('hidden');
                    resetView();
                    showToast("Plano cargado");
                }
                backgroundImg.src = event.target.result;
            }
            reader.readAsDataURL(file);
        }

        function screenToWorld(screenX, screenY) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const canvasX = (screenX - rect.left) * scaleX;
            const canvasY = (screenY - rect.top) * scaleY;
            return { x: (canvasX / camera.zoom) - camera.x, y: (canvasY / camera.zoom) - camera.y };
        }

        function handleMouseDown(e) {
            e.preventDefault();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const worldPos = screenToWorld(clientX, clientY);

            // Handle Add Point Mode
            if (isAddingPointMode) {
                const id = prompt("Ingresa el ID del nuevo puesto (ej: D-99):");
                if (id) {
                    networkPoints.push({
                        id: id.toUpperCase(),
                        x: worldPos.x / canvas.width,
                        y: worldPos.y / canvas.height
                    });
                    showToast("Puesto agregado: " + id);
                    draw();
                }
                return;
            }

            // Right click or Middle click for Pan
            if (e.button === 2 || e.button === 1) {
                isDraggingCanvas = true; lastMouseX = clientX; lastMouseY = clientY;
                canvas.style.cursor = 'grabbing'; return;
            }

            // Check Item Click (Reverse order to catch top items first)
            let clickedItem = null;
            for (let i = items.length - 1; i >= 0; i--) {
                const item = items[i];
                if (worldPos.x >= item.x - item.width/2 && worldPos.x <= item.x + item.width/2 &&
                    worldPos.y >= item.y - item.height/2 && worldPos.y <= item.y + item.height/2) {
                    clickedItem = item; break;
                }
            }

            // Check Point Click
            let clickedPoint = null;
             for (let i = 0; i < networkPoints.length; i++) {
                 const p = networkPoints[i];
                 const px = p.x * canvas.width;
                 const py = p.y * canvas.height;
                 if (Math.sqrt((worldPos.x - px)**2 + (worldPos.y - py)**2) < 20) {
                     clickedPoint = p; break;
                 }
             }

            if (clickedItem) {
                selectedItemId = clickedItem.id; selectedNetworkPointId = null;
                isDraggingItem = true; dragOffsetX = worldPos.x - clickedItem.x; dragOffsetY = worldPos.y - clickedItem.y;
                syncSliderToSelection();
            } else if (clickedPoint) {
                selectedNetworkPointId = clickedPoint.id; selectedItemId = null;
                isDraggingItem = true; // dragging point? Only if network mode.
                // If NOT network mode, just select it for context actions
                if (!isNetworkMode) isDraggingItem = false;
            } else {
                isDraggingCanvas = true; lastMouseX = clientX; lastMouseY = clientY;
                canvas.style.cursor = 'grabbing';
                selectedItemId = null; selectedNetworkPointId = null;
            }
            draw();
        }

        function handleMouseMove(e) {
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            if (isDraggingItem) {
                const worldPos = screenToWorld(clientX, clientY);
                if (selectedItemId) {
                    const item = items.find(i => i.id === selectedItemId);
                    if (item) { item.x = worldPos.x - dragOffsetX; item.y = worldPos.y - dragOffsetY; draw(); }
                } else if (selectedNetworkPointId && isNetworkMode) {
                    // Only move points in Network Mode
                    const point = networkPoints.find(p => p.id === selectedNetworkPointId);
                    if (point) { point.x = worldPos.x / canvas.width; point.y = worldPos.y / canvas.height; draw(); }
                }
            } else if (isDraggingCanvas) {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const dx = (clientX - lastMouseX) * scaleX;
                const dy = (clientY - lastMouseY) * scaleY;
                camera.x += dx / camera.zoom; camera.y += dy / camera.zoom;
                lastMouseX = clientX; lastMouseY = clientY;
                draw();
            }
        }

        function handleMouseUp() { isDraggingItem = false; isDraggingCanvas = false; canvas.style.cursor = 'grab'; }
        function handleWheel(e) { e.preventDefault(); changeZoom(-e.deltaY * 0.001); }
        
        function changeZoom(delta) {
            if (!backgroundImg) return;
            const newZoom = Math.min(Math.max(camera.zoom + delta, 0.1), 5);
            const w = canvas.width; const h = canvas.height;
            const centerWx = (w/2 / camera.zoom) - camera.x;
            const centerWy = (h/2 / camera.zoom) - camera.y;
            camera.zoom = newZoom;
            camera.x = (w/2 / camera.zoom) - centerWx;
            camera.y = (h/2 / camera.zoom) - centerWy;
            draw();
        }
        function resetView() {
            if (!backgroundImg) return;
            camera = { x: 0, y: 0, zoom: 0.9 };
            camera.x = (canvas.width - canvas.width*0.9)/2 / 0.9;
            camera.y = (canvas.height - canvas.height*0.9)/2 / 0.9;
            draw();
        }
        function handleTouchStart(e) { if (e.touches.length === 1) handleMouseDown(e); }
        function handleTouchMove(e) { if (e.touches.length === 1) handleMouseMove(e); }

        // --- Modes ---

        function toggleAddPointMode() {
            if (!backgroundImg) return showToast("Sube un plano primero", "error");
            isAddingPointMode = !isAddingPointMode;
            isNetworkMode = false; 
            updateModeUI();
            draw();
        }

        function toggleNetworkMode() {
            if (!backgroundImg) return showToast("Sube un plano primero", "error");
            isNetworkMode = !isNetworkMode;
            isAddingPointMode = false;
            updateModeUI();
            draw();
        }

        function updateModeUI() {
            const addBtn = document.getElementById('addPointBtn');
            const editBtn = document.getElementById('toggleNetworkBtn');
            
            addBtn.classList.toggle('tool-active', isAddingPointMode);
            editBtn.classList.toggle('tool-active', isNetworkMode);
            
            const modeText = document.getElementById('modeStatus');
            if(isAddingPointMode) { modeText.innerText = "Modo: Agregando Puestos"; modeText.className = "text-xs font-bold text-green-600 mt-2 text-center"; canvas.style.cursor='crosshair'; }
            else if(isNetworkMode) { modeText.innerText = "Modo: Editar Ubicación"; modeText.className = "text-xs font-bold text-blue-600 mt-2 text-center"; canvas.style.cursor='grab'; }
            else { modeText.innerText = "Modo: Navegación"; modeText.className = "text-[10px] text-gray-400 mt-2 text-center"; canvas.style.cursor='grab'; }
        }

        // --- Hardware ---
        function addItem(type) {
            if (!backgroundImg) return showToast("Sube un plano primero", "error");
            const id = Date.now();
            const viewCenterX = (canvas.width / 2 / camera.zoom) - camera.x;
            const viewCenterY = (canvas.height / 2 / camera.zoom) - camera.y;
            let width = 30, height = 30;
            
            if (type === 'monitor') { width = 60; height = 35; } 
            else if (type === 'monitor-single') { width = 35; height = 30; } 
            else if (type === 'desk') { width = 80; height = 45; } // Desk size

            items.push({ id, type, x: viewCenterX, y: viewCenterY, width, height, ratio: height/width });
            selectedItemId = id; selectedNetworkPointId = null;
            updateUI(); syncSliderToSelection(); draw();
        }

        function addItemToSelectedPoint(type) {
            if (!selectedNetworkPointId) return;
            const point = networkPoints.find(p => p.id === selectedNetworkPointId);
            if (!point) return;
            
            const px = point.x * canvas.width;
            const py = point.y * canvas.height;
            
            const id = Date.now();
            let width = 30, height = 30;
            let offsetY = -40; // Default offset for hardware

            if (type === 'monitor') { width = 60; height = 35; } 
            else if (type === 'monitor-single') { width = 35; height = 30; }
            else if (type === 'dock') { width = 30; height = 30; } 
            else if (type === 'desk') { 
                width = 80; height = 45; 
                offsetY = 0; // Desk centers on point
            }
            
            // Offset slightly if hardware already exists there to avoid perfect overlap
            // For desks, we usually want them centered, but if multiple desks, offset.
            const existingItems = items.filter(i => getNearestPoint(i)?.point.id === point.id && i.type === type);
            const offsetX = existingItems.length * 10;

            items.push({ id, type, x: px + offsetX, y: py + offsetY, width, height, ratio: height/width });
            
            selectedNetworkPointId = null; // Deselect point to show the item
            selectedItemId = id;
            
            draw();
            showToast(type === 'desk' ? "Escritorio agregado" : "Hardware agregado");
        }

        function deleteSelected() { if(selectedItemId) { items = items.filter(i => i.id !== selectedItemId); selectedItemId = null; updateUI(); draw(); } }
        function deleteSelectedPoint() { 
            if(selectedNetworkPointId && confirm("¿Borrar el puesto "+selectedNetworkPointId+"?")) { 
                networkPoints = networkPoints.filter(p => p.id !== selectedNetworkPointId); 
                selectedNetworkPointId = null; 
                draw(); 
            } 
        }
        function handleResizeChange(e) { 
            if (!selectedItemId) return; 
            const item = items.find(i => i.id === selectedItemId); 
            if (item) { item.width = parseInt(e.target.value); item.height = item.width * item.ratio; draw(); } 
        }
        function syncSliderToSelection() {
            const item = items.find(i => i.id === selectedItemId);
            if (item) { 
                sizeSlider.value = item.width; 
                document.getElementById('sizeValueDisplay').innerText = item.width + 'px'; 
                
                // Show assignment (skip for desks usually, or show it too)
                if (item.type !== 'desk') {
                    const nearest = getNearestPoint(item);
                    const infoBox = document.getElementById('assignmentInfo');
                    if (nearest) {
                        infoBox.classList.remove('hidden');
                        document.getElementById('assignmentText').innerText = "Conectado a: " + nearest.point.id;
                    } else {
                        infoBox.classList.add('hidden');
                    }
                } else {
                     document.getElementById('assignmentInfo').classList.add('hidden');
                }
            }
        }

        // --- Export Logic ---

        function exportToExcel() {
            if (!backgroundImg) return showToast("Nada para exportar", "error");

            let report = networkPoints.map(p => ({
                id: p.id,
                dualMonitors: 0,
                singleMonitors: 0,
                docks: 0,
                desks: 0,
                totalScreens: 0
            }));

            items.forEach(item => {
                const nearest = getNearestPoint(item);
                if (nearest) {
                    const idx = networkPoints.findIndex(p => p.id === nearest.point.id);
                    if (idx !== -1) {
                        if (item.type === 'monitor') report[idx].dualMonitors++;
                        else if (item.type === 'monitor-single') report[idx].singleMonitors++;
                        else if (item.type === 'dock') report[idx].docks++;
                        else if (item.type === 'desk') report[idx].desks++;
                    }
                }
            });

            report.forEach(r => { r.totalScreens = (r.dualMonitors * 2) + r.singleMonitors; });

            const csvRows = [];
            csvRows.push(['Puesto ID', 'Escritorios', 'Kits Doble Monitor', 'Monitores Simples', 'Total Pantallas', 'Docking Stations']);
            report.forEach(r => {
                csvRows.push([r.id, r.desks, r.dualMonitors, r.singleMonitors, r.totalScreens, r.docks]);
            });

            const csvString = csvRows.map(e => e.join(",")).join("\n");
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "inventario_oficina.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast("Excel descargado");
        }

        function exportImage() {
            if (!backgroundImg) return showToast("Nada para exportar", "error");
            const tempCam = {...camera};
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(backgroundImg, 0, 0);
            
            // Draw desks first for export
            items.filter(i => i.type === 'desk').forEach(item => {
                 ctx.save(); ctx.translate(item.x, item.y);
                 drawDeskIcon(ctx, -item.width/2, -item.height/2, item.width, item.height);
                 ctx.restore();
            });

            // Draw visual connections
            drawAssignments();
            drawNetworkPoints(0.6);
            
            // Draw hardware
            items.filter(i => i.type !== 'desk').forEach(i => {
                 ctx.save(); ctx.translate(i.x, i.y);
                 if(i.type==='monitor') drawMonitorIcon(ctx, -i.width/2, -i.height/2, i.width, i.height);
                 else if(i.type==='monitor-single') drawSingleMonitorIcon(ctx, -i.width/2, -i.height/2, i.width, i.height);
                 else if(i.type==='dock') drawDockIcon(ctx, -i.width/2, -i.height/2, i.width, i.height);
                 ctx.restore();
            });

            const link = document.createElement('a');
            link.download = 'layout_oficina.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
            camera = tempCam; draw();
            showToast("Imagen descargada");
        }

        function updateUI() {
            const dual = items.filter(i => i.type === 'monitor').length;
            const single = items.filter(i => i.type === 'monitor-single').length;
            const docks = items.filter(i => i.type === 'dock').length;
            const desks = items.filter(i => i.type === 'desk').length;
            
            document.getElementById('count-monitor').innerText = dual;
            document.getElementById('count-monitor-single').innerText = single;
            document.getElementById('count-dock').innerText = docks;
            document.getElementById('count-desk').innerText = desks;
            
            const selControls = document.getElementById('selectionControls');
            const ptControls = document.getElementById('pointContextActions');
            
            if (selectedItemId) {
                selControls.classList.remove('opacity-50', 'pointer-events-none');
                ptControls.classList.add('hidden');
            } else if (selectedNetworkPointId) {
                selControls.classList.add('opacity-50', 'pointer-events-none');
                ptControls.classList.remove('hidden');
                document.getElementById('selectedPointLabel').innerText = selectedNetworkPointId;
            } else {
                selControls.classList.add('opacity-50', 'pointer-events-none');
                ptControls.classList.add('hidden');
            }
        }

        function showToast(msg, type='success') {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            t.classList.remove('opacity-0');
            setTimeout(() => t.classList.add('opacity-0'), 3000);
        }
        
        canvas.addEventListener('contextmenu', event => event.preventDefault());
    </script>
</body>
</html>
